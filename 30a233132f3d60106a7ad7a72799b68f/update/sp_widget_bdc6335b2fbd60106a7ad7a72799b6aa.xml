<?xml version="1.0" encoding="UTF-8"?><record_update table="sp_widget">
    <sp_widget action="INSERT_OR_UPDATE">
        <category>custom</category>
        <client_script><![CDATA[function($scope,$rootScope, $location, $window, spUtil, amb, $http, spAriaUtil, $timeout, spNavStateManager){
	var c = this;
	var data = [];

	//Handling Submit button
	c.clickButton = function(action){
		var obj = {
			action: action,
			account: c.data.account,
			dc: c.data.dc,
			vmCount: c.data.vmCount,
			serverCount: c.data.serverCount
		};
		$rootScope.$broadcast('customEvent',obj);
	}

	c.getSelectedAccount= function() {
		c.server.update().then(function(data) {
		});
	}
	
	c.getSelectedDC= function() {
		c.server.update().then(function(data) {
		});
	}
}]]></client_script>
        <controller_as>c</controller_as>
        <css/>
        <data_table>sp_instance</data_table>
        <demo_data/>
        <description/>
        <docs/>
        <field_list/>
        <has_preview>false</has_preview>
        <id>custom_count</id>
        <internal>false</internal>
        <link><![CDATA[function link(scope, element, attrs, controller) {  }]]></link>
        <name>Custom Count</name>
        <option_schema/>
        <public>false</public>
        <roles/>
        <script><![CDATA[(function () {

	data.itemID = $sp.getParameter('sys_id') + '';
	data.serviceaccounts = [];
	data.logicalDataCenter = [];
	var gr= new GlideRecord('cmdb_ci_cloud_service_account');
	gr.addEncodedQuery('datacenter_type=cmdb_ci_rhv_ldc');
	gr.addOrderBy('name');
	gr.query();
	while(gr.next()){
		data.serviceaccounts.push(gr.getValue('account_id'));
	}
	getLDCSysid = function(account,ldc){
		var enc = "name="+ldc+"^u_management_interface="+account+'';
	//	gs.addInfoMessage("enc : "+enc);
		var ldc = new GlideRecord("cmdb_ci_rhv_ldc");
		ldc.addEncodedQuery(enc);
		ldc.query();
		if(ldc.next())
			return ldc.sys_id;
	}
	
	getClusterSysid = function(ldc_sys_id){
		var enc = "child.sys_class_name=cmdb_ci_rhv_cluster^parent.sys_class_name=cmdb_ci_rhv_ldc^parent="+ldc_sys_id;
	//	gs.addInfoMessage("enc : "+enc);
		var clusterid = new GlideRecord("cmdb_rel_ci");
		clusterid.addEncodedQuery(enc);
		clusterid.query();
		if(clusterid.next())
			return clusterid.child;
	}
	
	if(input.accounts != undefined){
		//sys_class_name=cmdb_ci_rhv_ldc^u_management_interface=https://m02.rhev.prod.int.ams2.redhat.com:443
		var dc= new GlideRecord('cmdb_ci_logical_datacenter');
		dc.addEncodedQuery("sys_class_name=cmdb_ci_rhv_ldc^u_management_interface="+input.accounts);
		dc.addOrderBy('name');
		dc.query();
		while(dc.next()){
			data.logicalDataCenter.push(dc.getValue('name'));
		}
	}
	var account = input.accounts;
	data.account = account;

	var ldc = input.datacenter;
	data.dc = ldc;

	var ldc_sys_id = getLDCSysid(account,ldc);



	var cluster_sysid = getClusterSysid(ldc_sys_id);

	
//	gs.addInfoMessage(ldc_sys_id + " " +cluster_sysid);
	var vm = new GlideRecord("cmdb_rel_ci");
	vm.addEncodedQuery("child.sys_class_name=cmdb_ci_rhv_ldc^child.name="+ldc+"^parent.sys_class_name=cmdb_ci_rhv_vm_instance");
	vm.query();
	data.vmCount = vm.getRowCount();

	var rhv = new GlideRecord("cmdb_rel_ci");
	rhv.addEncodedQuery("child.sys_class_name=cmdb_ci_rhv_server^parent="+cluster_sysid);
	rhv.query();
	data.serverCount = rhv.getRowCount();

})();]]></script>
        <servicenow>false</servicenow>
        <sys_class_name>sp_widget</sys_class_name>
        <sys_created_by>admin</sys_created_by>
        <sys_created_on>2021-01-24 23:29:05</sys_created_on>
        <sys_customer_update>false</sys_customer_update>
        <sys_id>bdc6335b2fbd60106a7ad7a72799b6aa</sys_id>
        <sys_mod_count>1</sys_mod_count>
        <sys_name>Custom Count</sys_name>
        <sys_package display_value="CustomDashboard" source="x_20346_customdash">30a233132f3d60106a7ad7a72799b68f</sys_package>
        <sys_policy/>
        <sys_replace_on_upgrade>false</sys_replace_on_upgrade>
        <sys_scope display_value="CustomDashboard">30a233132f3d60106a7ad7a72799b68f</sys_scope>
        <sys_update_name>sp_widget_bdc6335b2fbd60106a7ad7a72799b6aa</sys_update_name>
        <sys_updated_by>admin</sys_updated_by>
        <sys_updated_on>2021-01-24 23:30:45</sys_updated_on>
        <template><![CDATA[<form>
  <div class="form-group">
    <!-- <div id="container1" style="min-width: 200px; max-width: 1800px; height: 40px; margin: 0 auto"> -->
    Service Account
    <select id='accounts' class='select2-search' ng-model="c.data.accounts" ng-change="c.getSelectedAccount()" >
      <option ng-repeat="account in data.serviceaccounts" value="{{account}}">{{account}}</option>
    </select>
    Data Center

    <select id='datacenter' class='select2-search' ng-model="c.data.datacenter" ng-change="c.getSelectedDC()" >
      <option ng-repeat="ldc in data.logicalDataCenter" value="{{ldc}}">{{ldc}}</option>
    </select>

  </div>
  <div class="panel panel-default panel-body m-t m-b">
  <!--  <button class="btn btn-default" ng-click="c.clickCancelButton('Cancel')">Cancel</button> -->
    <button class="btn btn-primary" ng-click="c.clickButton('Submit')">Apply</button>
  </div>
</form>]]></template>
    </sp_widget>
</record_update>
